<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ToMoreBeyond - 面白いことだけをする。友と共に道なき道を越える</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  
  <style>
    /* リセットCSS */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    /* 基本スタイル */
    body {
      font-family: 'Share Tech Mono', monospace;
      overflow-x: hidden;
      overflow-y: auto;
      position: relative;
      background: #ffffff;
      margin: 0;
      padding: 0;
    }
    
    /* 背景動画コンテナ */
    .video-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
      background: #ffffff;
    }
    
    .video-background video {
      position: absolute;
      top: 50%;
      left: 50%;
      min-width: 100%;
      min-height: 100%;
      width: auto;
      height: auto;
      transform: translate(-50%, -50%);
      object-fit: cover;
    }
    
    /* 動画オーバーレイ */
    .video-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      pointer-events: none;
      z-index: 1;
    }
    
    /* メインコンテンツラッパー */
    .content-wrapper {
      position: relative;
      z-index: 1;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }
    
    /* ロゴ */
    .logo {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      font-family: 'Orbitron', monospace;
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      text-decoration: none;
      letter-spacing: 2px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
    
    /* メインゲームエリア */
    .game-area {
      position: relative;
      width: 100%;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* カードコンテナ */
    .cards-container {
      position: relative;
      width: 100%;
      height: 400px;
      overflow: hidden;
      padding: 0 50px;
    }
    
    .cards-track {
      display: flex;
      gap: 24px;
      transition: none;
      padding: 0 50px;
      transform: translateZ(0);
      backface-visibility: hidden;
      will-change: transform;
    }
    
    /* カードスタイル */
    .card {
      min-width: 280px;
      height: 360px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 4px solid #000;
      border-radius: 16px;
      padding: 32px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      transform: translate3d(0, 0, 0);
      backface-visibility: hidden;
      will-change: transform;
    }
    
    .card:hover {
      transform: translate3d(0, -10px, 0) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    
    .card-icon {
      font-size: 48px;
      margin-bottom: 20px;
      color: #000;
    }
    
    .card-title {
      font-family: 'Orbitron', monospace;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #000;
    }
    
    .card-description {
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }
    
    /* 8bit ドット絵風棒人間（元のサイズ） */
    .tiny-character {
      position: fixed;
      bottom: max(80px, calc(env(safe-area-inset-bottom) + 70px));
      left: 20px;
      transform: translateZ(0);
      width: 80px;
      height: 80px;
      z-index: 10000;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      will-change: left;
      backface-visibility: hidden;
      transition: left 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      opacity: 1 !important;
      visibility: visible !important;
      pointer-events: auto;
      cursor: pointer;
    }
    
    /* ジャンプアニメーション */
    .tiny-character.jumping {
      animation: jumpAnimation 0.6s ease;
    }
    
    @keyframes jumpAnimation {
      0% {
        transform: translateY(0) scaleX(1) scaleY(1);
      }
      20% {
        transform: translateY(-5px) scaleX(1.1) scaleY(0.9);
      }
      50% {
        transform: translateY(-80px) scaleX(0.95) scaleY(1.05);
      }
      80% {
        transform: translateY(-5px) scaleX(1.05) scaleY(0.95);
      }
      100% {
        transform: translateY(0) scaleX(1) scaleY(1);
      }
    }
    
    /* 最大レベル達成時の赤色表示 */
    .tiny-character.max-level-achieved .pixel {
      background: #dc3545 !important;
      box-shadow: 1px 1px 0 rgba(220, 53, 69, 0.3), 0 0 4px #dc3545;
    }
    
    .tiny-character.max-level-achieved {
      filter: drop-shadow(0 0 8px rgba(220, 53, 69, 0.6));
      animation: maxLevelGlow 2s ease-in-out infinite;
    }
    
    @keyframes maxLevelGlow {
      0%, 100% {
        filter: drop-shadow(0 0 8px rgba(220, 53, 69, 0.6));
      }
      50% {
        filter: drop-shadow(0 0 16px rgba(220, 53, 69, 0.9));
      }
    }
    
    /* 最大レベル時のジャンプアニメーション（高さ変更） */
    .tiny-character.max-level-achieved.jumping {
      animation: maxLevelJumpAnimation 0.6s ease;
    }
    
    @keyframes maxLevelJumpAnimation {
      0% {
        transform: translateY(0) scaleX(1) scaleY(1);
      }
      20% {
        transform: translateY(-20px) scaleX(1.1) scaleY(0.9);
      }
      50% {
        transform: translateY(-400px) scaleX(0.95) scaleY(1.05);
      }
      80% {
        transform: translateY(-20px) scaleX(1.05) scaleY(0.95);
      }
      100% {
        transform: translateY(0) scaleX(1) scaleY(1);
      }
    }
    
    /* ピクセルキャラクター用グリッド */
    .pixel-character {
      position: relative;
      width: 100%;
      height: 100%;
      /* ピクセルキャラクターが常に表示されるように */
      min-height: 80px;
    }
    
    .pixel-grid {
      position: relative;
      width: 100%;
      height: 100%;
      transform: scale(5);
      transform-origin: top left;
    }
    
    /* 個別ピクセル */
    .pixel {
      position: absolute;
      background: #000;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }
    
    /* GIF風コマ送り歩行アニメーション */
    .walking-animation-container {
      position: relative;
      width: 100%;
      height: 100%;
      /* コンテナが常に表示されるように */
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    /* 歩行フレーム */
    .walk-frame {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      visibility: hidden;
      transition: none; /* アニメーションをカクカクに */
    }
    
    .walk-frame.active {
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    /* アイドル状態では必ずアイドルフレームを表示 */
    .tiny-character:not(.walking) .walk-frame.idle {
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    /* 歩行中はアイドルフレームを完全に非表示 */
    .tiny-character.walking .walk-frame.idle {
      opacity: 0 !important;
      visibility: hidden !important;
    }
    
    /* キャラクターの歩行状態でのフレーム切り替え */
    /* Removed the rule that hides idle frame during walking to prevent character disappearing */
    
    /* レベル表示 */
    .level-display {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ffffff;
      padding: 12px 20px;
      border: 4px solid #22c55e;
      border-style: dashed;
      color: #22c55e;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      text-transform: uppercase;
      box-shadow: 
        inset 2px 2px 0px #f1f5f9,
        4px 4px 0px rgba(0, 0, 0, 0.3);
      image-rendering: pixelated;
      z-index: 1000;
      min-width: 120px;
    }
    
    .level-text {
      font-size: 16px;
      margin-bottom: 8px;
      text-align: center;
      letter-spacing: 2px;
    }
    
    .exp-bar {
      width: 100%;
      height: 12px;
      background: #e2e8f0;
      border: 2px solid #22c55e;
      position: relative;
      image-rendering: pixelated;
    }
    
    .exp-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      width: 0%;
      border-right: 2px solid #ffffff;
      box-sizing: border-box;
    }
    
    /* スターレベル時の特別スタイル */
    .level-display.max-level {
      border-color: #dc3545;
      color: #dc3545;
      background: #ffffff;
      animation: levelPulse 2s ease-in-out infinite;
      box-shadow: 
        inset 2px 2px 0px #fee2e2,
        4px 4px 0px rgba(220, 53, 69, 0.3),
        0 0 20px rgba(220, 53, 69, 0.5);
    }
    
    .level-display.max-level .exp-bar {
      border-color: #dc3545;
      background: #fef2f2;
    }
    
    .level-display.max-level .exp-fill {
      background: linear-gradient(90deg, #dc3545, #b91c1c);
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.6);
    }
    
    @keyframes levelPulse {
      0%, 100% { 
        transform: scale(1);
        box-shadow: 
          inset 2px 2px 0px #fee2e2,
          4px 4px 0px rgba(220, 53, 69, 0.3),
          0 0 20px rgba(220, 53, 69, 0.5);
      }
      50% { 
        transform: scale(1.05);
        box-shadow: 
          inset 2px 2px 0px #fee2e2,
          4px 4px 0px rgba(220, 53, 69, 0.5),
          0 0 30px rgba(220, 53, 69, 0.8);
      }
    }
    
    /* Level Up ポップアップ */
    .level-up-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: #0f172a;
      border: 6px dashed #22c55e;
      padding: 32px 40px;
      font-family: 'Orbitron', monospace;
      font-size: 32px;
      font-weight: 900;
      color: #22c55e;
      text-transform: uppercase;
      letter-spacing: 4px;
      z-index: 10000;
      box-shadow: 
        inset 4px 4px 0px #1e293b,
        8px 8px 0px rgba(0, 0, 0, 0.5),
        0 0 40px rgba(34, 197, 94, 0.6);
      image-rendering: pixelated;
      text-shadow: 
        2px 2px 0px #0f172a,
        0 0 20px #22c55e;
      animation: levelUpAnimation 3s ease-in-out forwards;
      pointer-events: none;
    }
    
    .level-up-popup.star-level {
      border-color: #dc3545;
      color: #dc3545;
      background: #1a0506;
      box-shadow: 
        inset 4px 4px 0px #2a0a0b,
        8px 8px 0px rgba(220, 53, 69, 0.5),
        0 0 40px rgba(220, 53, 69, 0.8);
      text-shadow: 
        2px 2px 0px #1a0506,
        0 0 20px #dc3545;
    }
    
    .level-up-popup.star-level::before {
      content: "★ ";
      animation: starPulse 0.5s ease-in-out infinite alternate;
    }
    
    .level-up-popup.star-level::after {
      content: " ★";
      animation: starPulse 0.5s ease-in-out infinite alternate;
    }
    
    @keyframes levelUpAnimation {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(-10deg);
        opacity: 0;
      }
      20% {
        transform: translate(-50%, -50%) scale(1.3) rotate(5deg);
        opacity: 1;
      }
      40% {
        transform: translate(-50%, -50%) scale(0.9) rotate(-2deg);
      }
      60% {
        transform: translate(-50%, -50%) scale(1.1) rotate(1deg);
      }
      80% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
      }
      100% {
        transform: translate(-50%, -50%) scale(0) rotate(0deg);
        opacity: 0;
      }
    }
    
    @keyframes starPulse {
      0% {
        text-shadow: 0 0 10px #dc3545;
        color: #dc3545;
      }
      100% {
        text-shadow: 0 0 30px #ff6b6b;
        color: #ff6b6b;
      }
    }
    
    /* レスポンシブ対応 */
    @media (max-width: 768px) {
      .logo {
        font-size: 18px;
      }
      
      .level-display {
        top: max(20px, calc(env(safe-area-inset-top) + 10px));
        right: max(20px, calc(env(safe-area-inset-right) + 10px));
        padding: 8px 12px;
        min-width: 100px;
        border-width: 3px;
        position: fixed;
        z-index: 10001;
      }
      
      .level-text {
        font-size: 14px;
        margin-bottom: 6px;
        letter-spacing: 1px;
      }
      
      .exp-bar {
        height: 10px;
        border-width: 2px;
      }
      
      .level-up-popup {
        font-size: 24px;
        padding: 24px 32px;
        letter-spacing: 2px;
        border-width: 4px;
      }
      
      .card {
        min-width: 240px;
        height: 320px;
        padding: 24px;
      }
      
      .card-icon {
        font-size: 40px;
      }
      
      .card-title {
        font-size: 18px;
      }
      
      .character-container {
        bottom: 60px;
        left: 30px;
      }
      
      .character {
        width: 50px;
        height: 70px;
      }
    }
    
    /* 小さなスクリーン用の追加調整 */
    @media (max-width: 480px) {
      .level-display {
        top: max(15px, calc(env(safe-area-inset-top) + 5px));
        right: max(15px, calc(env(safe-area-inset-right) + 5px));
        padding: 6px 10px;
        min-width: 90px;
        border-width: 2px;
      }
      
      .level-text {
        font-size: 12px;
        margin-bottom: 4px;
        letter-spacing: 1px;
      }
      
      .exp-bar {
        height: 8px;
        border-width: 1px;
      }
      
      .logo {
        font-size: 16px;
        top: max(15px, calc(env(safe-area-inset-top) + 5px));
        left: max(15px, calc(env(safe-area-inset-left) + 5px));
      }
    }
    
    /* パフォーマンス最適化 */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* 低スペックデバイス向け最適化 */
    .low-performance-mode .video-container video {
      display: none;
    }
    
    .low-performance-mode .video-overlay {
      background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
    }
    
    .low-performance-mode .card {
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      background: rgba(255, 255, 255, 0.98);
      transition: transform 0.2s ease !important;
    }
    
    .low-performance-mode .character-container {
      transition: left 0.3s linear !important;
    }
    
    /* GPUアクセラレーション最適化 */
    .cards-track {
      will-change: transform;
      transform: translateZ(0);
    }
    
    .character-container {
      will-change: left;
      transform: translateZ(0);
    }
    
    .card {
      will-change: transform;
      transform: translateZ(0);
    }
    
    /* ローディング表示（シンプル） */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }
    
    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-text {
      color: #fff;
      font-size: 18px;
      font-family: 'Orbitron', monospace;
    }
  </style>
</head>
<body>
  <!-- 背景動画 -->
  <div class="video-background" id="videoBackground">
    <video id="backgroundVideo" autoplay muted loop playsinline preload="auto">
      <source src="Timeline 1.mp4" type="video/mp4">
    </video>
    <div class="video-overlay"></div>
  </div>
  
  
  <!-- メインコンテンツ -->
  <div class="content-wrapper">
    <!-- ロゴ -->
    <a href="#" class="logo" id="logoButton">ToMoreBeyond</a>
    
    <!-- レベル表示 -->
    <div class="level-display">
      <div class="level-text">Level <span id="currentLevel">1</span></div>
      <div class="exp-bar">
        <div class="exp-fill" id="expFill"></div>
      </div>
    </div>
    
    <!-- ゲームエリア -->
    <div class="game-area">
      <div class="cards-container">
        <div class="cards-track" id="cardsTrack">
          <!-- カードは動的に生成 -->
        </div>
      </div>
    </div>
    
    <!-- 8bit ドット絵風歩行アニメーション棒人間 -->
    <div class="tiny-character" id="tinyCharacter" role="img" aria-label="歩行中のキャラクター">
      <div class="walking-animation-container">
        
        <!-- アイドルフレーム: シンプルな棒人間 -->
        <div class="walk-frame idle pixel-character active">
          <div class="pixel-grid">
            <!-- 頭部 (3x3の四角) -->
            <div class="pixel" style="top: 1px; left: 6px; width: 3px; height: 3px;"></div>
            
            <!-- 胴体 (縦線 4ピクセル) -->
            <div class="pixel" style="top: 4px; left: 7px; width: 1px; height: 4px;"></div>
            
            <!-- 左腕 (水平線) -->
            <div class="pixel" style="top: 5px; left: 4px; width: 3px; height: 1px;"></div>
            
            <!-- 右腕 (水平線) -->
            <div class="pixel" style="top: 5px; left: 8px; width: 3px; height: 1px;"></div>
            
            <!-- 左脚 (斜め下) -->
            <div class="pixel" style="top: 8px; left: 6px; width: 1px; height: 3px;"></div>
            
            <!-- 右脚 (斜め下) -->
            <div class="pixel" style="top: 8px; left: 8px; width: 1px; height: 3px;"></div>
          </div>
        </div>
        
        <!-- フレーム1: 歩行ポーズ（左脚前進） -->
        <div class="walk-frame frame1 pixel-character">
          <div class="pixel-grid">
            <!-- 頭部 (3x3の四角) -->
            <div class="pixel" style="top: 1px; left: 6px; width: 3px; height: 3px;"></div>
            
            <!-- 胴体 (縦線 4ピクセル) -->
            <div class="pixel" style="top: 4px; left: 7px; width: 1px; height: 4px;"></div>
            
            <!-- 左腕 (上向き) -->
            <div class="pixel" style="top: 4px; left: 5px; width: 2px; height: 1px;"></div>
            <div class="pixel" style="top: 3px; left: 5px; width: 1px; height: 1px;"></div>
            
            <!-- 右腕 (下向き) -->
            <div class="pixel" style="top: 6px; left: 8px; width: 2px; height: 1px;"></div>
            <div class="pixel" style="top: 7px; left: 9px; width: 1px; height: 1px;"></div>
            
            <!-- 左脚 (前進) -->
            <div class="pixel" style="top: 8px; left: 5px; width: 1px; height: 2px;"></div>
            <div class="pixel" style="top: 10px; left: 4px; width: 1px; height: 1px;"></div>
            
            <!-- 右脚 (後方) -->
            <div class="pixel" style="top: 8px; left: 8px; width: 1px; height: 2px;"></div>
            <div class="pixel" style="top: 10px; left: 9px; width: 1px; height: 1px;"></div>
          </div>
        </div>
        
        <!-- フレーム2: 歩行ポーズ（右脚前進） -->
        <div class="walk-frame frame2 pixel-character">
          <div class="pixel-grid">
            <!-- 頭部 (3x3の四角) -->
            <div class="pixel" style="top: 1px; left: 6px; width: 3px; height: 3px;"></div>
            
            <!-- 胴体 (縦線 4ピクセル) -->
            <div class="pixel" style="top: 4px; left: 7px; width: 1px; height: 4px;"></div>
            
            <!-- 左腕 (下向き) -->
            <div class="pixel" style="top: 6px; left: 5px; width: 2px; height: 1px;"></div>
            <div class="pixel" style="top: 7px; left: 4px; width: 1px; height: 1px;"></div>
            
            <!-- 右腕 (上向き) -->
            <div class="pixel" style="top: 4px; left: 8px; width: 2px; height: 1px;"></div>
            <div class="pixel" style="top: 3px; left: 9px; width: 1px; height: 1px;"></div>
            
            <!-- 左脚 (後方) -->
            <div class="pixel" style="top: 8px; left: 6px; width: 1px; height: 2px;"></div>
            <div class="pixel" style="top: 10px; left: 5px; width: 1px; height: 1px;"></div>
            
            <!-- 右脚 (前進) -->
            <div class="pixel" style="top: 8px; left: 8px; width: 1px; height: 2px;"></div>
            <div class="pixel" style="top: 10px; left: 9px; width: 1px; height: 1px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ローディング -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-text">Loading...</div>
  </div>
  
  <script>
    // ゲームクラス
    class MinimalSite {
      constructor() {
        this.cards = [
          { icon: '[]', title: '会社概要', description: 'MICHI NAKI MICHI WO KIRU', link: 'detail/company.html' },
          { icon: 'X', title: 'ミッション', description: 'OMOSHIROI KOTO DAKE WO SURU', link: 'detail/mission.html' },
          { icon: '+', title: 'TADATAKA', description: 'IDOU GA SONO MAMA NIKKI NI', link: 'pages/tadataka.html' },
          { icon: 'T', title: 'TOIRUN', description: 'IMA SUGU TOIRE WO SAITAN DE', link: 'pages/toirun.html' },
          { icon: 'M', title: 'MEET IN THE MIDDLE', description: 'SAITEKI NA SHUUGOU CHITEN WO', link: 'pages/midpoint.html' },
          { icon: 'Y', title: '山田', description: 'CDO / DESIGNER', link: 'detail/yamada.html' },
          { icon: 'M', title: '正留', description: 'CEO / ENGINEER', link: 'detail/masadome.html' },
          { icon: 'A', title: '安藤', description: 'ARTIST', link: 'detail/ando.html' },
          { icon: 'S', title: 'SNS', description: 'HIBI NO HASSHIN', link: 'detail/sns.html' },
          { icon: '@', title: 'お問い合わせ', description: 'OKI GARU NI DOUZO', link: 'detail/contact.html' }
        ];
        
        this.currentLevel = 1;
        this.currentExp = 0;
        this.maxExp = 100;
        this.characterPosition = 0;
        this.viewedCards = new Set();
        
        // メモリ最適化のための設定
        this.isLowEndDevice = this.detectLowEndDevice();
        this.lastUpdateTime = 0;
        this.rafId = null;
        this.eventListeners = [];
        this.walkFrameInterval = null;
        this.walkingTimeout = null;
        
        this.init();
      }
      
      detectLowEndDevice() {
        // メモリ制限のチェック
        if ('deviceMemory' in navigator && navigator.deviceMemory < 2) {
          return true;
        }
        
        // CPUコア数のチェック
        if ('hardwareConcurrency' in navigator && navigator.hardwareConcurrency <= 2) {
          return true;
        }
        
        // ネットワーク速度のチェック
        if ('connection' in navigator) {
          const connection = navigator.connection;
          if (connection.saveData || connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
            return true;
          }
        }
        
        return false;
      }
      
      throttle(func, wait) {
        let timeout;
        let previous = 0;
        
        return function executedFunction(...args) {
          const now = Date.now();
          const remaining = wait - (now - previous);
          
          if (remaining <= 0 || remaining > wait) {
            if (timeout) {
              clearTimeout(timeout);
              timeout = null;
            }
            previous = now;
            func.apply(this, args);
          } else if (!timeout) {
            timeout = setTimeout(() => {
              previous = Date.now();
              timeout = null;
              func.apply(this, args);
            }, remaining);
          }
        };
      }
      
      init() {
        // 低スペックデバイスの場合はパフォーマンスモードを適用
        if (this.isLowEndDevice) {
          document.body.classList.add('low-performance-mode');
        }
        
        // カードを生成
        this.createCards();
        
        // イベントリスナー設定
        this.setupEventListeners();
        
        // キャラクタークリックイベント
        this.setupCharacterEvents();
        
        // 背景動画初期化
        this.initializeBackgroundVideo();
        
        // メモリ監視のセットアップ
        this.setupMemoryMonitoring();
        
        // ゲーム状態を読み込み
        this.loadGameState();
        
        // キャラクターを表示
        this.showCharacter();
        
        // ローディング完了
        this.hideLoading();
        
        // 定期的に状態を保存
        setInterval(() => {
          this.saveGameState();
        }, 5000);
      }
      
      showCharacter() {
        const character = document.getElementById('tinyCharacter');
        if (character) {
          // 確実に表示
          character.style.opacity = '1';
          character.style.visibility = 'visible';
          character.style.display = 'block';
          character.style.pointerEvents = 'auto';
          character.style.transform = 'translateZ(0)';
          character.style.webkitTransform = 'translateZ(0)';
          
          // 初期位置を設定
          character.style.left = '20px';
          
          // 最初のカード位置を更新
          this.updatePositions();
        }
      }
      
      setupMemoryMonitoring() {
        // メモリ監視（低スペックデバイスのみ）
        if (this.isLowEndDevice && 'performance' in window && 'memory' in performance) {
          setInterval(() => {
            const memoryInfo = performance.memory;
            const memoryUsageRatio = memoryInfo.usedJSHeapSize / memoryInfo.jsHeapSizeLimit;
            
            if (memoryUsageRatio > 0.8) {
              this.emergencyCleanup();
            }
          }, 30000); // 30秒ごとにチェック
        }
      }
      
      emergencyCleanup() {
        // 緊急メモリクリーンアップ
        console.warn('⚠️ メモリクリーンアップ実行');
        
        // 不要なデータをクリア
        this.viewedCards.clear();
        
        // 動画を一時停止
        const video = document.getElementById('bgVideo');
        if (video) {
          video.pause();
        }
        
        // アニメーションを停止
        if (this.rafId) {
          cancelAnimationFrame(this.rafId);
          this.rafId = null;
        }
      }
      
      createCards() {
        const track = document.getElementById('cardsTrack');
        
        this.cards.forEach((card, index) => {
          const cardEl = document.createElement('div');
          cardEl.className = 'card';
          cardEl.dataset.index = index;
          cardEl.innerHTML = `
            <div class="card-icon">${card.icon}</div>
            <h3 class="card-title">${card.title}</h3>
            <p class="card-description">${card.description}</p>
          `;
          
          // カードクリックで詳細ページに遷移 + レベルアップ
          cardEl.addEventListener('click', () => {
            this.onCardClick(index, card);
          });
          
          track.appendChild(cardEl);
        });
      }
      
      setupEventListeners() {
        // パフォーマンス最適化されたイベントリスナー
        const wheelHandler = this.throttle((e) => {
          // ゲームエリア内かどうかを確認
          const gameArea = document.querySelector('.game-area');
          const rect = gameArea.getBoundingClientRect();
          const isInGameArea = rect.top <= 0 && rect.bottom >= window.innerHeight;
          
          // ゲームエリア外では通常のスクロールを許可
          if (!isInGameArea) {
            return;
          }
          
          // ゲームエリア内では横スクロールのみ処理
          if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
            // 横スクロールが主な場合
            e.preventDefault();
            this.handleScroll(e.deltaX);
          } else if (e.deltaY !== 0 && Math.abs(e.deltaX) < 5) {
            // 縦スクロールが主な場合は、ゲームエリアの端でのみ処理
            const atLeftEdge = this.characterPosition <= 0.01;
            const atRightEdge = this.characterPosition >= 0.99;
            
            if (!atLeftEdge && !atRightEdge) {
              // ゲームエリアの中間では縦スクロールを横スクロールに変換
              e.preventDefault();
              this.handleScroll(e.deltaY);
            }
            // 端にいる場合は通常の縦スクロールを許可
          }
        }, 16); // 60fps
        
        const keyHandler = (e) => {
          if (e.key === 'ArrowRight') {
            this.moveCharacter(0.05);
          } else if (e.key === 'ArrowLeft') {
            this.moveCharacter(-0.05);
          } else if (e.key === ' ') {
            e.preventDefault();
            this.jump();
          }
        };
        
        // タッチ操作（モバイル）- 改善版
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartPosition = 0;
        let touchStartTime = 0;
        let lastTouchX = 0;
        let lastTouchTime = 0;
        let isTouching = false;
        let isHorizontalSwipe = null;
        let inertiaVelocity = 0;
        let inertiaAnimationId = null;
        
        const touchStartHandler = (e) => {
          // ゲームエリア内でのタッチのみ処理
          const gameArea = document.querySelector('.game-area');
          const touch = e.touches[0];
          const element = document.elementFromPoint(touch.clientX, touch.clientY);
          
          // ゲームエリアまたはその子要素でのタッチのみ処理
          if (gameArea && (gameArea === element || gameArea.contains(element))) {
            // 慣性スクロールを停止
            if (inertiaAnimationId) {
              cancelAnimationFrame(inertiaAnimationId);
              inertiaAnimationId = null;
            }
            
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            touchStartPosition = this.characterPosition;
            touchStartTime = Date.now();
            lastTouchX = touch.clientX;
            lastTouchTime = touchStartTime;
            isTouching = true;
            isHorizontalSwipe = null;
            inertiaVelocity = 0;
          }
        };
        
        const touchMoveHandler = (e) => {
          if (!isTouching) return;
          
          const touch = e.touches[0];
          const diffX = touch.clientX - touchStartX;
          const diffY = touch.clientY - touchStartY;
          
          // スワイプ方向を初回判定
          if (isHorizontalSwipe === null && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) {
            isHorizontalSwipe = Math.abs(diffX) > Math.abs(diffY);
          }
          
          // 横スワイプの場合のみゲーム操作
          if (isHorizontalSwipe) {
            e.preventDefault();
            
            // カードの総幅と移動可能な距離を計算
            const cardWidth = 280 + 24; // カード幅 + マージン
            const totalCardsWidth = cardWidth * this.cards.length;
            const viewportWidth = window.innerWidth;
            const maxScrollDistance = Math.max(0, totalCardsWidth - viewportWidth + 200);
            
            // タッチの移動距離を位置の変化に変換
            // 左スワイプ（diffXが正）= 右へ移動（characterPositionが増加）
            const pixelsMoved = -diffX; // 左スワイプで負、右スワイプで正
            const positionDelta = pixelsMoved / maxScrollDistance;
            
            // 開始位置からの相対的な移動
            const newPosition = touchStartPosition + positionDelta;
            this.characterPosition = Math.max(0, Math.min(1, newPosition));
            
            // 即座に位置を更新
            this.updatePositions();
            
            // 速度を計算（慣性スクロール用）
            const currentTime = Date.now();
            const timeDiff = currentTime - lastTouchTime;
            if (timeDiff > 0) {
              inertiaVelocity = (touch.clientX - lastTouchX) / timeDiff;
            }
            lastTouchX = touch.clientX;
            lastTouchTime = currentTime;
            
            // 歩行アニメーション
            if (Math.abs(diffX) > 2) {
              this.startWalkingAnimation();
              clearTimeout(this.walkingTimeout);
              this.walkingTimeout = setTimeout(() => {
                this.stopWalkingAnimation();
              }, 200);
            }
          }
          // 縦スワイプの場合は通常のスクロールを許可
        };
        
        const touchEndHandler = () => {
          if (!isTouching) return;
          
          isTouching = false;
          
          // 横スワイプの場合のみ慣性スクロールを適用
          if (isHorizontalSwipe && Math.abs(inertiaVelocity) > 0.3) {
            const applyInertia = () => {
              // 摩擦を適用（より速く減速）
              inertiaVelocity *= 0.92;
              
              // 速度が小さくなったら停止
              if (Math.abs(inertiaVelocity) < 0.05) {
                cancelAnimationFrame(inertiaAnimationId);
                inertiaAnimationId = null;
                this.stopWalkingAnimation();
                this.saveGameState();
                return;
              }
              
              // 速度に基づいて位置を更新
              const cardWidth = 280 + 24;
              const totalCardsWidth = cardWidth * this.cards.length;
              const viewportWidth = window.innerWidth;
              const maxScrollDistance = Math.max(0, totalCardsWidth - viewportWidth + 200);
              
              const deltaPosition = -(inertiaVelocity * 16) / maxScrollDistance;
              this.characterPosition = Math.max(0, Math.min(1, this.characterPosition + deltaPosition));
              this.updatePositions();
              
              inertiaAnimationId = requestAnimationFrame(applyInertia);
            };
            
            inertiaAnimationId = requestAnimationFrame(applyInertia);
          } else {
            // 慣性なしの場合は即座に保存
            this.stopWalkingAnimation();
            if (this.characterPosition !== touchStartPosition) {
              this.saveGameState();
            }
          }
          
          isHorizontalSwipe = null;
        };
        
        // ロゴクリックでリセット
        const logoButton = document.getElementById('logoButton');
        const logoClickHandler = (e) => {
          e.preventDefault();
          if (confirm('レベルを1にリセットしますか？')) {
            this.resetGame();
          }
        };
        logoButton.addEventListener('click', logoClickHandler);
        
        // イベントリスナーを登録
        document.addEventListener('wheel', wheelHandler, { passive: false });
        document.addEventListener('keydown', keyHandler);
        document.addEventListener('touchstart', touchStartHandler, { passive: true });
        document.addEventListener('touchmove', touchMoveHandler, { passive: false });
        document.addEventListener('touchend', touchEndHandler, { passive: true });
        
        // クリーンアップ用に保存
        this.eventListeners.push(
          { element: logoButton, type: 'click', handler: logoClickHandler },
          { element: document, type: 'wheel', handler: wheelHandler },
          { element: document, type: 'keydown', handler: keyHandler },
          { element: document, type: 'touchstart', handler: touchStartHandler },
          { element: document, type: 'touchmove', handler: touchMoveHandler },
          { element: document, type: 'touchend', handler: touchEndHandler }
        );
      }
      
      setupCharacterEvents() {
        const character = document.getElementById('tinyCharacter');
        if (character) {
          const jumpHandler = () => this.jump();
          character.addEventListener('click', jumpHandler);
          character.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              this.jump();
            }
          });
          
          this.eventListeners.push(
            { element: character, type: 'click', handler: jumpHandler }
          );
        }
      }
      
      throttle(func, limit) {
        let inThrottle;
        return function() {
          const args = arguments;
          const context = this;
          if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      }
      
      setupCharacterEvents() {
        const character = document.getElementById('tinyCharacter');
        if (character) {
          character.addEventListener('click', () => {
            this.jump();
            this.play8BitSound('jump');
          });
        }
      }
      
      initializeBackgroundVideo() {
        const video = document.getElementById('backgroundVideo');
        
        if (!video) return;
        
        // 動画の基本設定を確実に行う
        video.muted = true;
        video.loop = true;
        video.playsInline = true;
        video.autoplay = true;
        
        // 動画の読み込み完了を待つ
        video.addEventListener('loadeddata', () => {
          video.play().then(() => {
          }).catch(() => {
            // ユーザーインタラクションで再生を試みる
            document.addEventListener('click', () => {
              video.play();
            }, { once: true });
          });
        });
        
        
        // 動画エラー時のフォールバック
        video.addEventListener('error', () => {
        });
        
        // 即座に読み込み開始
        video.load();
      }
      
      hideLoading() {
        setTimeout(() => {
          const loadingOverlay = document.getElementById('loadingOverlay');
          loadingOverlay.classList.add('hidden');
          
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 500);
        }, 1000);
      }
      
      handleScroll(deltaX) {
        // スクロール量を位置に変換（右スクロール = 右移動）
        const sensitivity = 0.003; // より反応的なスクロール感度
        const scrollAmount = deltaX * sensitivity; // 正の値で右へ
        this.moveCharacter(scrollAmount);
        
        // 歩行アニメーションを開始
        this.startWalkingAnimation();
        
        // 歩行停止タイマー
        clearTimeout(this.walkingTimeout);
        this.walkingTimeout = setTimeout(() => {
          this.stopWalkingAnimation();
        }, 200);
      }
      
      startWalkingAnimation() {
        const character = document.getElementById('tinyCharacter');
        if (character && !character.classList.contains('walking')) {
          character.classList.add('walking');
          this.animateWalkFrames();
        }
      }
      
      stopWalkingAnimation() {
        const character = document.getElementById('tinyCharacter');
        if (character) {
          character.classList.remove('walking');
          this.stopWalkFrames();
        }
      }
      
      animateWalkFrames() {
        if (this.walkFrameInterval) return;
        
        const character = document.getElementById('tinyCharacter');
        if (!character) return;
        
        const frames = character.querySelectorAll('.walk-frame');
        if (frames.length < 3) return;
        
        // アイドルフレームを非表示
        frames[0].classList.remove('active');
        
        // 最初の歩行フレームを表示
        let currentFrame = 1;
        frames[currentFrame].classList.add('active');
        
        // 歩行アニメーション開始（8bitゲーム風の速度）
        this.walkFrameInterval = setInterval(() => {
          // 現在のフレームを非表示
          frames[currentFrame].classList.remove('active');
          
          // 次のフレームに切り替え（1と2を交互に）
          currentFrame = currentFrame === 1 ? 2 : 1;
          
          // 新しいフレームを表示
          frames[currentFrame].classList.add('active');
        }, 150); // 8bitゲーム風の速度に調整
      }
      
      stopWalkFrames() {
        if (this.walkFrameInterval) {
          clearInterval(this.walkFrameInterval);
          this.walkFrameInterval = null;
        }
        
        const frames = document.querySelectorAll('.walk-frame');
        if (frames.length > 0) {
          // Ensure idle frame is visible first
          frames[0].classList.add('active');
          
          // Then remove active from walking frames
          for (let i = 1; i < frames.length; i++) {
            frames[i].classList.remove('active');
          }
        }
      }
      
      moveCharacter(amount) {
        // キャラクター位置を更新（0〜1の範囲）
        this.characterPosition = Math.max(0, Math.min(1, this.characterPosition + amount));
        
        // キャラクターとカードを移動
        this.updatePositions();
      }
      
      updatePositions() {
        // RAFでパフォーマンス最適化
        if (this.rafId) {
          cancelAnimationFrame(this.rafId);
        }
        
        this.rafId = requestAnimationFrame(() => {
          const character = document.getElementById('tinyCharacter');
          const track = document.getElementById('cardsTrack');
          const screenWidth = window.innerWidth;
          
          if (!character || !track) return;
          
          // 確実に表示状態を維持
          character.style.opacity = '1';
          character.style.visibility = 'visible';
          character.style.display = 'block';
          character.style.pointerEvents = 'auto';
          
          
          // モバイルでの表示を強制
          character.style.transform = 'translateZ(0)';
          character.style.webkitTransform = 'translateZ(0)';
          
          // 改善されたキャラクター位置計算（線形で連続的）
          const minPosition = 50; // 最小位置（左端）
          const maxPosition = screenWidth - 100; // 最大位置（右端）
          const travelDistance = maxPosition - minPosition;
          
          // 線形補間で連続的な位置計算
          const charX = minPosition + (travelDistance * this.characterPosition);
          
          // キャラクター位置を更新
          character.style.left = charX + 'px';
          
          // カードスクロール計算（キャラクター位置と同期）
          const cardWidth = 280 + 24; // カード幅 + マージン
          const totalCardsWidth = cardWidth * this.cards.length;
          const containerPadding = 100; // 左右のパディング
          const maxScrollDistance = Math.max(0, totalCardsWidth - screenWidth + containerPadding * 2);
          
          // キャラクター位置に完全同期したスクロール（3D変換で最適化）
          const scrollX = -maxScrollDistance * this.characterPosition;
          track.style.transform = `translate3d(${scrollX}px, 0, 0)`;
          
          // 現在のカードをハイライト
          const currentCardIndex = Math.round(this.characterPosition * (this.cards.length - 1));
          this.highlightCard(currentCardIndex);
        });
      }
      
      highlightCard(index) {
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, i) => {
          if (i === index) {
            card.style.transform = 'translate3d(0, -5px, 0) scale(1.02)';
            card.style.boxShadow = '0 20px 40px rgba(0,0,0,0.4)';
          } else {
            card.style.transform = 'translate3d(0, 0, 0)';
            card.style.boxShadow = '';
          }
        });
      }
      
      onCardClick(index, card) {
        if (!this.viewedCards.has(index)) {
          this.viewedCards.add(index);
          // カード1枚で1レベルアップ（ポップアップ後に遷移）
          this.levelUpWithNavigation(card, index);
          // カードクリック時にゲーム状態保存
          this.saveGameState();
        } else {
          // 既に見たカードは即座に遷移
          this.navigateToDetail(card, index);
        }
      }
      
      gainExp(amount) {
        this.currentExp += amount;
        
        if (this.currentExp >= this.maxExp) {
          this.levelUp();
        }
        
        this.updateUI();
      }
      
      levelUp() {
        console.log('Level up called, current level:', this.currentLevel);
        this.currentLevel++;
        this.currentExp = 0;
        console.log('New level:', this.currentLevel);
        
        // Level Upポップアップを表示
        this.showLevelUpPopup();
        
        // 8bitレベルアップエフェクト
        const character = document.getElementById('tinyCharacter');
        if (character) {
          character.classList.add('level-up');
          setTimeout(() => {
            character.classList.remove('level-up');
          }, 2000);
        }
        
        // 最大レベル時は赤色 + スター状態
        if (this.currentLevel >= 10) {
          setTimeout(() => {
            this.activateMaxLevelEffect();
          }, 2000);
        }
        
        // レベルアップサウンド
        this.play8BitSound('levelup');
        
        // ゲーム状態を保存
        this.saveGameState();
      }
      
      levelUpWithNavigation(card, index) {
        this.currentLevel++;
        this.currentExp = 0;
        
        // Level Upポップアップを表示してから遷移
        this.showLevelUpPopupWithNavigation(card, index);
        
        // 8bitレベルアップエフェクト
        const character = document.getElementById('tinyCharacter');
        if (character) {
          character.classList.add('level-up');
          setTimeout(() => {
            character.classList.remove('level-up');
          }, 2000);
        }
        
        // 最大レベル時は赤色 + スター状態
        if (this.currentLevel >= 10) {
          setTimeout(() => {
            this.activateMaxLevelEffect();
          }, 2000);
        }
        
        // レベルアップサウンド
        this.play8BitSound('levelup');
        
        // UIを更新
        this.updateUI();
        
        // ゲーム状態を保存
        this.saveGameState();
      }
      
      showLevelUpPopup() {
        console.log('Showing level up popup for level:', this.currentLevel);
        
        // 既存のポップアップを削除
        const existingPopup = document.querySelector('.level-up-popup');
        if (existingPopup) {
          existingPopup.remove();
        }
        
        // 新しいポップアップを作成
        const popup = document.createElement('div');
        popup.className = 'level-up-popup';
        
        // スターレベル時は特別なスタイル
        if (this.currentLevel >= 10) {
          popup.classList.add('star-level');
          popup.textContent = 'STAR LEVEL!';
        } else {
          popup.textContent = 'LEVEL UP!';
        }
        
        console.log('Popup created and added to DOM');
        
        // DOMに追加
        document.body.appendChild(popup);
        
        // 3秒後に削除（視認性を高めるため）
        setTimeout(() => {
          if (popup.parentNode) {
            popup.remove();
            console.log('Popup removed');
          }
        }, 3000);
      }
      
      showLevelUpPopupWithNavigation(card, index) {
        // 既存のポップアップを削除
        const existingPopup = document.querySelector('.level-up-popup');
        if (existingPopup) {
          existingPopup.remove();
        }
        
        // 新しいポップアップを作成
        const popup = document.createElement('div');
        popup.className = 'level-up-popup';
        
        // スターレベル時は特別なスタイル
        if (this.currentLevel >= 10) {
          popup.classList.add('star-level');
          popup.textContent = 'STAR LEVEL!';
        } else {
          popup.textContent = 'LEVEL UP!';
        }
        
        // DOMに追加
        document.body.appendChild(popup);
        
        // 3秒後に削除してから詳細画面に遷移
        setTimeout(() => {
          if (popup.parentNode) {
            popup.remove();
          }
          // ポップアップが消えてから詳細画面に遷移
          this.navigateToDetail(card, index);
        }, 3000);
      }
      
      updateUI() {
        const levelEl = document.getElementById('currentLevel');
        const expFill = document.getElementById('expFill');
        
        levelEl.textContent = this.currentLevel;
        expFill.style.width = (this.currentExp / this.maxExp * 100) + '%';
      }
      
      jump() {
        const character = document.getElementById('tinyCharacter');
        if (character && !character.classList.contains('jumping')) {
          character.classList.add('jumping');
          
          setTimeout(() => {
            character.classList.remove('jumping');
          }, 600);
        }
      }
      
      navigateToDetail(card, index) {
        // レベルとゲーム状態を保存
        this.saveGameState();
        
        // 詳細ページに遷移（レベル保持パラメータ付き）
        if (card.link) {
          const currentUrl = new URL(card.link, window.location.href);
          currentUrl.searchParams.set('level', this.currentLevel);
          currentUrl.searchParams.set('from', 'main');
          currentUrl.searchParams.set('cardIndex', index);
          
          window.location.href = currentUrl.toString();
        }
      }
      
      saveGameState() {
        const gameState = {
          currentLevel: this.currentLevel,
          currentExp: this.currentExp,
          characterPosition: this.characterPosition,
          viewedCards: Array.from(this.viewedCards),
          timestamp: Date.now()
        };
        
        localStorage.setItem('tomorebeyond_game_state', JSON.stringify(gameState));
      }
      
      loadGameState() {
        try {
          const saved = localStorage.getItem('tomorebeyond_game_state');
          if (saved) {
            const gameState = JSON.parse(saved);
            
            this.currentLevel = gameState.currentLevel || 1;
            this.currentExp = gameState.currentExp || 0;
            this.characterPosition = gameState.characterPosition || 0;
            this.viewedCards = new Set(gameState.viewedCards || []);
            
            // UI更新
            this.updateUI();
            this.updatePositions();
            
            // 最大レベル時のエフェクト適用
            if (this.currentLevel >= 10) {
              this.activateMaxLevelEffect();
            }
          }
        } catch (error) {
          console.error('ゲーム状態の読み込みに失敗:', error);
        }
      }
      
      resetGame() {
        // ゲーム状態をリセット
        this.currentLevel = 1;
        this.currentExp = 0;
        this.characterPosition = 0;
        this.viewedCards.clear();
        
        // LocalStorageをクリア
        localStorage.removeItem('tomorebeyond_game_state');
        
        // キャラクターとレベル表示のクラスをリセット
        const character = document.getElementById('tinyCharacter');
        const levelDisplay = document.querySelector('.level-display');
        
        if (character) {
          character.classList.remove('max-level-achieved');
        }
        
        if (levelDisplay) {
          levelDisplay.classList.remove('max-level');
        }
        
        // UIを更新
        this.updateUI();
        this.updatePositions();
        
        // レベルリセットの効果音
        this.play8BitSound('levelup');
        
        // リセット完了の通知
        this.showNotification('レベルが1にリセットされました！');
      }
      
      activateMaxLevelEffect() {
        const character = document.getElementById('tinyCharacter');
        const levelDisplay = document.querySelector('.level-display');
        
        if (character) {
          character.classList.add('max-level-achieved');
        }
        
        if (levelDisplay) {
          levelDisplay.classList.add('max-level');
        }
      }
      
      play8BitSound(type) {
        // Web Audio APIを使用した8bitサウンド生成
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          switch(type) {
            case 'levelup':
              oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
              oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
              oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
              gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
              oscillator.start(audioContext.currentTime);
              oscillator.stop(audioContext.currentTime + 0.3);
              break;
            case 'jump':
              oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.1);
              gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
              oscillator.start(audioContext.currentTime);
              oscillator.stop(audioContext.currentTime + 0.1);
              break;
          }
        } catch (e) {
          // 音声再生エラーは無視
        }
      }
      
      showNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #22c55e;
          color: #0f172a;
          padding: 20px 40px;
          font-family: 'Orbitron', monospace;
          font-size: 18px;
          font-weight: 700;
          border: 4px solid #0f172a;
          z-index: 10000;
          animation: fadeInOut 2s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 2000);
      }
      
      cleanup() {
        // イベントリスナーをクリーンアップ
        this.eventListeners.forEach(({ element, type, handler }) => {
          element.removeEventListener(type, handler);
        });
        this.eventListeners = [];
        
        // RAFをキャンセル
        if (this.rafId) {
          cancelAnimationFrame(this.rafId);
          this.rafId = null;
        }
        
        // 歩行アニメーションをクリーンアップ
        this.stopWalkFrames();
        
        // 動画を停止
        const video = document.getElementById('backgroundVideo');
        if (video) {
          video.pause();
          video.src = '';
        }
        
        // データをクリア
        this.viewedCards.clear();
        this.cards = null;
        
        console.log('🧹 ゲームクリーンアップ完了');
      }
    }
    
    // ゲーム開始
    document.addEventListener('DOMContentLoaded', () => {
      window.gameInstance = new MinimalSite();
      
      // 動画の自動再生を即座に試行
      const video = document.getElementById('backgroundVideo');
      if (video) {
        // すでに読み込まれている場合は即座に再生
        if (video.readyState >= 3) {
          video.play().catch(() => {});
        }
        // まだの場合はcanplayイベントで再生
        video.addEventListener('canplay', () => {
          video.play().catch(() => {});
        }, { once: true });
      }
    });
    
    // ページ離脱時のクリーンアップ
    window.addEventListener('beforeunload', () => {
      if (window.gameInstance) {
        window.gameInstance.cleanup();
      }
    });
    
    // バックグラウンドでのメモリ最適化
    document.addEventListener('visibilitychange', () => {
      if (window.gameInstance) {
        const video = document.getElementById('backgroundVideo');
        if (document.hidden) {
          // バックグラウンドで動画を一時停止
          if (video) video.pause();
        } else {
          // フォアグラウンドで動画を再開
          if (video && !window.gameInstance.isLowEndDevice) {
            video.play().catch(() => {});
          }
        }
      }
    });

    // スクロールインジケーターのクリックイベント
    document.addEventListener('DOMContentLoaded', () => {
      const scrollIndicator = document.querySelector('.scroll-indicator');
      const companySection = document.querySelector('.company-section');
      
      if (scrollIndicator && companySection) {
        scrollIndicator.addEventListener('click', () => {
          companySection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        });
      }

      // 企業セクションが表示されたらインジケーターを非表示
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            scrollIndicator.style.opacity = '0';
            scrollIndicator.style.pointerEvents = 'none';
          } else {
            scrollIndicator.style.opacity = '1';
            scrollIndicator.style.pointerEvents = 'auto';
          }
        });
      }, { threshold: 0.1 });

      if (companySection) {
        observer.observe(companySection);
      }
    });

    // トップに戻る関数
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }
  </script>

  <!-- スクロールインジケーター -->
  <div class="scroll-indicator">
    <div class="scroll-text">SCROLL DOWN FOR MORE</div>
    <div class="scroll-arrow">↓</div>
  </div>

  <!-- 企業情報セクション（ゲームエリアの下） -->
  <section class="company-section">
    <div class="section-container">
      <!-- 会社概要 -->
      <div class="company-intro">
        <h2 class="section-title">ToMoreBeyond</h2>
        <p class="section-subtitle">技術と情熱で、人々の日常をより豊かに</p>
        <p class="company-description">
          私たちは「面白いことだけをする。友と共に道なき道を越える」をミッションに、<br>
          革新的なモバイルアプリケーション開発を通じて、人々の行動半径を広げ、<br>
          日常をより楽しく豊かにするテクノロジー企業です。
        </p>
      </div>

      <!-- サービス一覧 -->
      <div class="services-grid">
        <h3 class="grid-title">Our Services</h3>
        <div class="service-cards">
          <div class="service-card">
            <div class="service-icon">📍</div>
            <h4 class="service-name">TADATAKA</h4>
            <p class="service-desc">移動がそのまま日記になる位置情報記録アプリ</p>
            <a href="pages/tadataka.html" class="service-link">詳細を見る →</a>
          </div>
          <div class="service-card">
            <div class="service-icon">🚻</div>
            <h4 class="service-name">TOIRUN</h4>
            <p class="service-desc">今すぐトイレを最短で見つけるナビゲーションアプリ</p>
            <a href="pages/toirun.html" class="service-link">詳細を見る →</a>
          </div>
          <div class="service-card">
            <div class="service-icon">🎯</div>
            <h4 class="service-name">MEET IN THE MIDDLE</h4>
            <p class="service-desc">最適な集合地点を瞬時に提案するアプリ</p>
            <a href="pages/midpoint.html" class="service-link">詳細を見る →</a>
          </div>
        </div>
      </div>

      <!-- チームメンバー -->
      <div class="team-section">
        <h3 class="grid-title">Our Team</h3>
        <div class="team-grid">
          <div class="team-card">
            <div class="member-avatar">Y</div>
            <h4 class="member-name">山田 隼大</h4>
            <p class="member-role">CDO / Designer</p>
            <a href="detail/yamada.html" class="member-link">プロフィール →</a>
          </div>
          <div class="team-card">
            <div class="member-avatar">M</div>
            <h4 class="member-name">正留 聖也</h4>
            <p class="member-role">CEO / Engineer</p>
            <a href="detail/masadome.html" class="member-link">プロフィール →</a>
          </div>
          <div class="team-card">
            <div class="member-avatar">A</div>
            <h4 class="member-name">安藤 俊平</h4>
            <p class="member-role">Artist</p>
            <a href="detail/ando.html" class="member-link">プロフィール →</a>
          </div>
        </div>
      </div>

      <!-- CTA -->
      <div class="cta-section">
        <h3 class="cta-title">一緒に新しい価値を創造しませんか？</h3>
        <p class="cta-description">
          ToMoreBeyondは常に新しい挑戦を求めています。<br>
          技術と創造性で世界を変えたい方、ぜひご連絡ください。
        </p>
        <a href="detail/contact.html" class="cta-button">お問い合わせ</a>
      </div>

      <!-- トップに戻るボタン -->
      <div class="back-to-top">
        <button class="back-to-top-btn" onclick="scrollToTop()">
          <span>↑</span>
          <span>BACK TO GAME</span>
        </button>
      </div>
    </div>
  </section>

  <!-- 企業情報セクション用のCSS -->
  <style>
    /* スクロールインジケーター */
    .scroll-indicator {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      z-index: 1000;
      color: #22c55e;
      font-family: 'Share Tech Mono', monospace;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .scroll-indicator:hover {
      transform: translateX(-50%) translateY(-5px);
    }

    .scroll-text {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    .scroll-arrow {
      font-size: 24px;
      animation: bounce 2s infinite;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }

    /* モバイルでのスクロールインジケーター調整 */
    @media (max-width: 768px) {
      .scroll-indicator {
        bottom: 20px;
      }
      
      .scroll-text {
        font-size: 12px;
      }
      
      .scroll-arrow {
        font-size: 20px;
      }
    }

    /* 企業情報セクション */
    .company-section {
      position: relative;
      background: #ffffff;
      padding: 80px 0;
      min-height: 100vh;
      z-index: 10;
    }

    .section-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* 会社紹介 */
    .company-intro {
      text-align: center;
      margin-bottom: 80px;
    }

    .section-title {
      font-family: 'Orbitron', monospace;
      font-size: 3rem;
      font-weight: 900;
      color: #22c55e;
      margin-bottom: 16px;
      text-transform: uppercase;
      text-shadow: 2px 2px 0px #0f172a;
    }

    .section-subtitle {
      font-size: 1.5rem;
      color: #64748b;
      margin-bottom: 24px;
    }

    .company-description {
      font-size: 1.1rem;
      line-height: 1.8;
      color: #0f172a;
      max-width: 800px;
      margin: 0 auto;
    }

    /* サービスグリッド */
    .services-grid {
      margin-bottom: 80px;
    }

    .grid-title {
      font-family: 'Orbitron', monospace;
      font-size: 2rem;
      font-weight: 700;
      color: #0f172a;
      text-align: center;
      margin-bottom: 48px;
      text-transform: uppercase;
    }

    .service-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 32px;
    }

    .service-card {
      background: #ffffff;
      border: 4px dashed #22c55e;
      padding: 32px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .service-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
      border-color: #16a34a;
    }

    .service-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .service-name {
      font-family: 'Orbitron', monospace;
      font-size: 1.5rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 12px;
    }

    .service-desc {
      color: #64748b;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .service-link {
      display: inline-block;
      color: #22c55e;
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .service-link:hover {
      color: #16a34a;
      transform: translateX(4px);
    }

    /* チームセクション */
    .team-section {
      margin-bottom: 80px;
    }

    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 32px;
    }

    .team-card {
      background: #ffffff;
      border: 4px solid #0f172a;
      padding: 32px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .team-card:hover {
      border-color: #22c55e;
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .member-avatar {
      width: 80px;
      height: 80px;
      background: #22c55e;
      color: #ffffff;
      font-family: 'Orbitron', monospace;
      font-size: 2rem;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      border: 4px solid #0f172a;
    }

    .member-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }

    .member-role {
      color: #64748b;
      margin-bottom: 16px;
    }

    .member-link {
      display: inline-block;
      color: #22c55e;
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .member-link:hover {
      color: #16a34a;
      transform: translateX(4px);
    }

    /* CTA セクション */
    .cta-section {
      background: #0f172a;
      padding: 60px;
      text-align: center;
      border: 6px dashed #22c55e;
    }

    /* トップに戻るボタン */
    .back-to-top {
      text-align: center;
      margin-top: 60px;
    }

    .back-to-top-btn {
      background: #22c55e;
      color: #0f172a;
      border: 4px solid #22c55e;
      padding: 20px 40px;
      font-family: 'Orbitron', monospace;
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin: 0 auto;
    }

    .back-to-top-btn:hover {
      background: transparent;
      color: #22c55e;
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(34, 197, 94, 0.3);
    }

    .back-to-top-btn span:first-child {
      font-size: 24px;
      animation: bounce-up 2s infinite;
    }

    @keyframes bounce-up {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(5px);
      }
      60% {
        transform: translateY(2px);
      }
    }

    .cta-title {
      font-family: 'Orbitron', monospace;
      font-size: 2rem;
      font-weight: 700;
      color: #22c55e;
      margin-bottom: 20px;
    }

    .cta-description {
      color: #e2e8f0;
      font-size: 1.1rem;
      line-height: 1.8;
      margin-bottom: 32px;
    }

    .cta-button {
      display: inline-block;
      background: #22c55e;
      color: #0f172a;
      padding: 16px 48px;
      font-family: 'Orbitron', monospace;
      font-size: 1.1rem;
      font-weight: 700;
      text-decoration: none;
      text-transform: uppercase;
      border: 4px solid #22c55e;
      transition: all 0.3s ease;
    }

    .cta-button:hover {
      background: transparent;
      color: #22c55e;
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(34, 197, 94, 0.3);
    }

    /* レスポンシブ対応 */
    @media (max-width: 768px) {
      .section-title {
        font-size: 2rem;
      }
      
      .section-subtitle {
        font-size: 1.2rem;
      }
      
      .company-description {
        font-size: 1rem;
      }
      
      .service-cards {
        grid-template-columns: 1fr;
      }
      
      .team-grid {
        grid-template-columns: 1fr;
      }
      
      .cta-section {
        padding: 40px 20px;
      }
    }
  </style>
</body>
</html>