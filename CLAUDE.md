# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際のClaude Code (claude.ai/code) へのガイダンスを提供します。

## プロジェクト概要

ToMoreBeyondは、ゲーミフィケーション要素を備えたインタラクティブな8ビットレトロゲームを特徴とする日本のテクノロジー企業のウェブサイトです。このサイトは8bitcn.comにインスパイアされたデザインシステムを使用し、カードを見ることで経験値を得る歩くピクセルアートキャラクターを採用しています。

## アーキテクチャ

### コア構造
- **ハイブリッドアーキテクチャ**: 8ビットゲーム (100vh) + 下部に従来型の企業ウェブサイトセクション
- **自己完結型シングルページアプリケーション**: シンプルさのため、すべてのコードを`index.html`に埋め込み
- **横スクロールゲーム**: キャラクターがカードコレクションを左から右に移動
- **バニラJavaScript**: フレームワークなし、純粋なJavaScriptゲームエンジン
- **8bitcnデザインシステム**: ピクセルパーフェクトなボーダー、破線、レトロタイポグラフィ
- **縦スクロール有効**: ゲームエリアは100vhで固定、企業セクションは下にスクロール
- **背景ビデオシステム**: パフォーマンス最適化を施した8ビットレトロゲーム美学

### 主要コンポーネント

#### メインゲームエンジン (`index.html`内のMinimalSiteクラス)
- **レベルシステム**: プレイヤーはカードクリックごとに1レベル獲得（スター状態の最大レベル10）
- **キャラクターコントローラー**: ジャンプ機能付きピクセルアートキャラクター
- **カードシステム**: 合計10枚のカード（UX簡素化のためブログとビデオカードは削除）
- **オーディオシステム**: 8ビットサウンドエフェクト用のWeb Audio API
- **通知システム**: レベルアップポップアップと完了エフェクト
- **LocalStorage**: ブラウザセッション間での進行状況の永続化

#### 企業ウェブサイトセクション
- **会社紹介**: ミッションステートメントと会社概要
- **サービスグリッド**: 3つの主要アプリ（TADATAKA、TOIRUN、MEET IN THE MIDDLE）
- **チームセクション**: 詳細ページへのリンク付きメンバープロフィール
- **コールトゥアクション**: ビジネスお問い合わせ用のコンタクトセクション
- **ナビゲーション**: ゲームと企業セクション間のスムーズスクロール

#### ゲーム初期化システム
- **GameInitializer**: ローディングシーケンスとDOM準備完了時の初期化
- **クリティカルCSS**: 高速レンダリングのためにインライン化、非クリティカルCSSは`<style>`タグ内
- **カード作成**: `cardsData`配列からの動的HTML生成
- **パフォーマンス最適化**: ハードウェアアクセラレーションとメモリ管理

#### ゲーム機能
- **レベリング**: `currentLevel`、`viewedCards` Set、永続化付き経験値トラッキング
- **キャラクター状態**: 歩行アニメーション、ジャンプ、最大レベルでの色変更
- **サウンドエフェクト**: Web Audio API経由のレベルアップ、ジャンプ、歩行、完了音
- **視覚的フィードバック**: レベル表示UI、経験値バー、完了エフェクト
- **アクセシビリティ**: ARIA属性、キーボードナビゲーション、スクリーンリーダーサポート
- **モバイルコントロール**: キャラクター移動用のタッチベースドラッグコントロール、長押しサポート付き矢印ボタン
- **デスクトップコントロール**: 横移動用の縦スクロール、キーボードナビゲーション（矢印キー、スペースでジャンプ）

### ファイル構成
```
/index.html              - メインゲームインターフェース（埋め込みCSS/JSを含む自己完結型）
/detail/                - 個別コンテンツ用のカード詳細ページ
/pages/                 - 製品ページ（tadataka.html、toirun.htmlなど）
/css/                   - レガシーCSSファイル（現在未使用）
/js/components/         - レガシーJSモジュール（現在未使用）
/assets/                - メディアコンテンツ仕様とブランドガイドライン
/metadata.json          - サイト全体のメタデータとSEO設定
/site.webmanifest       - PWAマニフェストファイル
/VIDEO_SETUP.md         - 背景ビデオ設定ガイド
/.gitignore             - 大きなビデオファイルを除外（backvideo.mp4）
```

### 現在のアーキテクチャに関する注記
- **モノリシック構造**: すべてのゲームロジック、スタイル、データを`index.html`に埋め込み
- **ビルドプロセスなし**: 直接的なHTML/CSS/JS - コンパイルやバンドルは不要
- **静的ホスティング**: 任意の静的ファイルサーバーから提供可能
- **クリーンな依存関係**: シンプルさのため、詳細ページからすべての外部JS参照を削除
- **SEO最適化**: ハイブリッド構造により、インタラクティブなゲーム体験と従来型の企業コンテンツの両方を提供

## 開発コマンド

静的HTMLサイト - ビルドプロセス不要:

```bash
# ローカル開発
python -m http.server 8000
# または
npx serve .
```

## 主要な技術的詳細

### ゲームメカニクス
- **経験値システム**: クリックベースのレベリング、カードクリックごとに1レベル
- **開始位置**: キャラクターは位置0（最左のカード）から開始
- **カードインタラクション**: カードクリックのみがレベル進行をトリガー
- **ジャンプメカニクス**: 0.6秒のアニメーション、クリック/タップ/スペースバーでアクセス可能
  - 通常ジャンプ: `jumpAnimation`キーフレームで80pxの高さ
  - スター状態ジャンプ: `maxLevelJumpAnimation`キーフレームで400pxの高さ
- **完了トリガー**: レベル10で赤いキャラクター色変更とスーパージャンプをトリガー
- **スター状態機能**: グロー効果付き赤色、5倍のジャンプ高さ、同じ歩行アニメーション
- **リセット機能**: ロゴクリックで確認ダイアログを表示し、レベル1にリセット
- **レベルアップポップアップ**: 詳細ページへ移動する前の3秒間のポップアップアニメーション
- **進行度の計算式**: `characterPosition = scrollX / maxScrollDistance` (0-1の範囲)

### 8bitcnデザイン実装
- **カラー**: ダークテーマ (#0f172a, #1e293b)、アクセントカラー (#22c55e, #3b82f6, #eab308)
- **フォント**: Orbitron（ヘッダー）、Share Tech Mono（コンテンツ）、ピクセル化レンダリング
- **カードデザイン**: 6pxの破線ボーダー、ピクセルパーフェクトなコーナー、8ビットシャドウ効果
- **テキストレンダリング**: `image-rendering: pixelated`、ハードシャドウ
- **統一デザイン**: すべての詳細ページが一貫した8ビット美学に従う
- **ナビゲーション**: すべてのページで「← BACK TO GAME」ボタンを含む一貫したナビゲーションバー

### レスポンシブブレークポイント
- モバイル: ≤768px（調整されたカードサイズ、小さいフォント、タッチ最適化）
- デスクトップ: >768px（フルサイズカード、ホバーエフェクト）

## コンテンツ管理

### カードデータ構造 (index.html内に埋め込み)
```javascript
{
  icon: '[]',         // ASCIIアイコン
  title: '会社概要',  // 日本語タイトル
  description: 'MICHI NAKI MICHI WO KIRU', // 大文字説明
  section: 'company', // セクショングループ
  link: 'detail/company.html'
}
```

### 現在のカード設定
- **カード総数**: 10枚（ブログとビデオカードは削除）
- **セクション**: company, apps, members, media, contact
- **仕切りなし**: UXの簡素化のためセクション仕切りカードを削除
- **埋め込みデータ**: すべてのカードデータはindex.html内の`window.cardsData`配列に格納

### ゲーム要素の追加
- **レベル**: スターレベルトリガー (`this.currentLevel >= 10`) を変更し、`cardsData`配列の長さを調整
- **カード**: `loadGameData()`メソッド内の`cardsData`配列にエントリを追加
- **サウンド**: `play8BitSound()`メソッドにケースを追加
- **アニメーション**: 歩行フレーム内のキャラクターピクセルdivを更新

## パフォーマンスアーキテクチャ

### Core Web Vitalsの実装
- **LCP最適化**: クリティカルCSSを`<head>`にインライン化、メインCSSを`<body>`に配置
- **FID改善**: `DOMContentLoaded`でゲーム初期化
- **CLS防止**: 固定ゲームビューポート高さ (100vh)、企業セクションの制御された縦スクロール
- **メモリ管理**: `destroy()`メソッドを使用した完全なクリーンアップシステム

### パフォーマンス機能
- **ハードウェアアクセラレーション**: `translateZ(0)`、`will-change: transform`
- **モノリシックローディング**: 単一HTMLファイルによりHTTPリクエストを削減
- **イベント委譲**: 最適化されたカードインタラクション
- **デバイス検出**: 低スペックデバイスの最適化
- **メモリ制限**: `viewedCards` Setの自動クリーンアップ
- **背景ビデオ**: 低スペックデバイスで自動無効化、モバイルで不透明度を低減
- **進行状況の永続化**: 複数の保存ポイント (beforeunload, pagehide, visibility change)
- **自動保存間隔**: レベル進行の5秒ごとの定期保存

## デザインシステム

### 8bitcn美学（すべてのページで統一）
- **カラー**: ダークテーマ (#0f172a, #1e293b)、アクセントカラー (#22c55e, #3b82f6, #eab308)
- **タイポグラフィ**: Orbitron（ヘッダー）、Share Tech Mono（コンテンツ）、ピクセル化レンダリング
- **ボーダー**: 6pxの破線ボーダー、ピクセルパーフェクトなコーナー
- **インタラクション**: 即座のフィードバック (0.1s-0.3sのトランジション)、translateYホバー効果
- **ゲーム要素**: ASCIIアイコン、大文字説明、レトロカラーパレット
- **日本語コンテンツ**: すべてのUIテキストが日本語
- **ページテンプレート**: すべての詳細ページがtadataka.htmlのデザインパターンに従う
- **ナビゲーション構造**: company、member、media、contactページ全体で一貫したナビゲーションバー

### アクセシビリティ基準
- **WCAG 2.1 AA準拠**: カラーコントラスト、キーボードナビゲーション
- **ARIA属性**: スクリーンリーダー用のラベル、ロール、ライブリージョン
- **キーボードサポート**: Tabナビゲーション、Enter/Spaceアクティベーション、矢印キー移動
- **ハイコントラストモード**: Windowsとブラウザのハイコントラストサポート
- **モーション削減**: `prefers-reduced-motion`メディアクエリサポート

### ブランドガイドライン
以下を含む完全なデザイン仕様については`/assets/brand-guidelines.md`を参照:
- カラーパレットの定義と使用規則
- タイポグラフィ階層とフォント仕様  
- UIコンポーネントパターンとレスポンシブブレークポイント
- `/assets/media-content-specifications.md`内のアセット要件

## データ管理

### メタデータシステム
- **中央設定**: `/metadata.json`にすべてのサイトメタデータを格納
- **SEOデータ**: ページタイトル、説明、キーワード、OGP設定
- **チーム情報**: メンバープロフィール、役割、専門分野
- **製品データ**: アプリケーション機能、説明、ステータス
- **技術スタック**: フロントエンド、バックエンド、モバイル、ツールの仕様

### コンテンツ構造
- **モジュラーコンテンツ**: 各ページが一貫した情報のためにメタデータを参照
- **多言語対応**: 日本語プライマリで英語の代替名付き
- **アセット管理**: 必要な画像/ビデオの整理されたメディア仕様

## 背景ビデオのセットアップ

ローカル開発の場合、`backvideo.mp4`をプロジェクトルートに配置します。プロダクションの場合、外部ホスティングを使用します（詳細はVIDEO_SETUP.mdを参照）。ビデオファイルはサイズ制約 (>100MB) のため`.gitignore`経由でgitから除外されています。

## 最近の重要な修正

### 背景ビデオシステム
- **問題**: 複雑なデバイス検出とフォールバックシステムが再生失敗を引き起こしていた
- **解決策**: `autoplay`、`muted`、`loop`、`playsinline`を使用した基本的なHTML5ビデオに簡素化
- **実装**: 複数の再生試行戦略を持つ単一の`initializeBackgroundVideo()`メソッド
- **現在のビデオ**: 背景ビデオファイルとして`Timeline 1.mp4`を使用

### キャラクター移動と位置システム
- **問題**: キャラクターが途中で停止し、スクロール中に消えていた
- **解決策**: 線形補間を使用して`updatePositions()`メソッドを完全に書き直し
- **実装**: 
  - 位置計算の簡素化: `charX = minPosition + (travelDistance * this.characterPosition)`
  - 各RAF更新で明示的な可視性プロパティを追加
  - 複雑な3フェーズ位置ロジック（開始/中間/終了）を削除
  - キャラクター位置とカードスクロールの完璧な同期

### カードインタラクションとレベルシステム
- **問題**: カードクリックが望ましくないキャラクター位置変更を引き起こしていた
- **解決策**: カード表示とキャラクター移動を分離
- **実装**: 
  - カードクリックはレベル進行のみをトリガー（1カード = 1レベル）
  - キャラクター移動はスクロール/キーボード入力のみで制御
  - 最大レベル（12）で赤いキャラクター色+スーパージャンプ能力をトリガー
  - スター状態: 視覚的変化（赤色、グロー）と強化されたジャンプ高さ（400px）のみ

### ページ間のレベル永続化
- **問題**: 詳細ページから戻ったときにレベルがリセットされていた
- **解決策**: URLパラメーターシステムとLocalStorageバックアップを追加
- **実装**: 
  - URLパラメーター: `?level=persist&from=detail&cardIndex=N`
  - LocalStorageキー: `tomorebeyond_game_state`
  - カード表示、ページアンロード、5秒ごとに自動保存

### スクロール方向と自然なコントロール
- **問題**: 不自然なスクロール方向（左スクロール = 右移動）
- **解決策**: 直感的なコントロールのためにスクロール処理を反転
- **実装**: 右スクロール = 右移動、モバイルとデスクトップの両方で動作

## 一般的な問題のトラブルシューティング

### 背景ビデオが再生されない
1. `Timeline 1.mp4`がプロジェクトルートに存在することを確認（現在のビデオファイル）
2. ブラウザの自動再生ポリシーを確認（最新のブラウザはユーザーインタラクションが必要）
3. ビデオ属性を確認: `autoplay muted loop playsinline`
4. 開発中は右上隅にビデオステータスインジケーターが表示
5. ビデオ初期化は`initializeBackgroundVideo()`メソッドで実行

### キャラクター位置の問題
- キャラクター移動は線形補間を使用した`updatePositions()`で制御
- キャラクターは`minPosition` (50px) から`maxPosition` (screenWidth - 100px) までスムーズに移動する必要がある
- キャラクターが消える場合: `opacity: '1'`、`visibility: 'visible'`、`display: 'block'`が設定されていることを確認
- カードクリックはキャラクターを移動させるべきではない - レベル進行のみをトリガー
- スクロールベースの移動は正確な同期のために`characterPosition` (0-1の範囲) を使用

### レベル/進行状況の喪失
- LocalStorageで`tomorebeyond_game_state`を確認
- ページ間を移動するときにURLパラメーターが保持されていることを確認  
- 進行状況の保存: カード表示時、ページアンロード前、5秒ごと、可視性変更時
- レベル変更後に`saveGameState()`が呼ばれていることを確認

### パフォーマンスの問題
- 低スペックデバイスは自動的に`.low-performance-mode`クラスを取得
- RAF最適化により過剰な位置更新を防止
- 低スペックデバイスでは30秒ごとにメモリ監視を実行
- メモリ使用率 > 80%の場合、緊急クリーンアップがアニメーションを停止しビデオを一時停止

## キャラクターアニメーションシステム
- **ピクセルアートキャラクター**: 歩行アニメーションフレーム付き8ビットスタイルの棒人間
- **歩行状態**: アイドル、フレーム1（左足前）、フレーム2（右足前）
- **ジャンプアニメーション**: キャラクター状態に基づく2つの異なるアニメーション:
  - `jumpAnimation`: レベル1-11用の通常ジャンプ (80px)
  - `maxLevelJumpAnimation`: レベル12+スター状態用のスーパージャンプ (400px)
- **スター状態メカニクス**: 
  - 視覚のみ: グロー効果付き赤色 (#dc3545)
  - 強化されたジャンプ高さ（通常の5倍）
  - 歩行アニメーションは変更なし
  - 回転や複雑な動きの変更なし

### CSSアニメーションアーキテクチャ
- **フレームベースの歩行**: `.walk-frame`要素間の不透明度切り替えを使用
- **ハードウェアアクセラレーション**: すべてのアニメーションがGPUアクセラレーションのために`transform`プロパティを使用
- **パフォーマンス最適化**: `will-change`、`transform: translateZ(0)`、`backface-visibility: hidden`
- **状態管理**: CSSクラスがキャラクター状態を制御 (`.walking`、`.jumping`、`.max-level-achieved`)

### ページデザインの統一
すべての詳細ページが8ビットデザインシステムに従うよう統一:
- `/detail/company.html`、`/detail/mission.html`、`/detail/contact.html`
- `/detail/yamada.html`、`/detail/masadome.html`、`/detail/ando.html`（メンバープロフィール）
- `/detail/sns.html`（コンテンツページ、ブログとビデオは削除）
- `/pages/tadataka.html`、`/pages/toirun.html`、`/pages/midpoint.html`（製品ページ）

デザインテンプレートパターンに含まれるもの:
- ロゴと「BACK TO GAME」ボタンを含む一貫したナビゲーション
- 読みやすさを向上させるための暗いテキスト付き白背景
- カードとセクションの6px破線ボーダー
- Orbitron/Share Tech Monoタイポグラフィ
- スクロールアニメーションとホバー効果
- レスポンシブグリッドレイアウト
- クリーンなアーキテクチャのためにすべての外部JS依存関係を削除

## ハイブリッド構造の実装

### ナビゲーションシステム
- **スクロールインジケーター**: ゲームエリア下部に「SCROLL DOWN FOR MORE」のアニメーション付きインジケーター
- **自動非表示**: 企業セクションが表示されるとインジケーターが消える
- **スムーズスクロール**: クリックイベントが企業セクションへのスムーズスクロールをトリガー
- **トップに戻る**: 企業セクションの「BACK TO GAME」ボタンでゲームエリアに戻る

### 企業セクションレイアウト
- **会社紹介**: ミッションステートメントと概要
- **サービスグリッド**: 詳細ページへのリンク付き3つの主要アプリケーション
- **チームセクション**: アバタープレースホルダーとプロフィールリンク付きメンバープロフィール
- **コールトゥアクション**: ビジネスお問い合わせの招待付きコンタクトセクション
- **一貫したスタイリング**: 企業セクション全体で維持される8ビット美学

### SEOの利点
- **従来型コンテンツ**: 企業セクションが検索エンジン用のクロール可能なコンテンツを提供
- **構造化データ**: 詳細ページのリッチメタデータとスキーママークアップ
- **コンテンツ階層**: ユーザーと検索ボットの両方に対する明確な情報アーキテクチャ
- **内部リンク**: ゲーム要素と企業ページ間の適切なナビゲーション

## 一般的な開発ワークフロー

### ローカルで変更をテスト
1. ローカルサーバーを起動: `python -m http.server 8000` または `npx serve .`
2. ブラウザで `http://localhost:8000` を開く
3. ブラウザのDevToolsを使用してコンソールエラーとネットワークリクエストを監視
4. デスクトップとモバイルの両方のビューポートでテスト

### ゲームロジックの変更
1. すべてのゲームコードは`index.html`内の`MinimalSite`クラスにある
2. 変更する主要メソッド:
   - `handleCardView()`: カードクリックロジックとレベル進行
   - `updatePositions()`: キャラクター移動と同期
   - `play8BitSound()`: オーディオフィードバックシステム
   - `checkLevelCompletion()`: スター状態トリガーロジック

### 新しいカードの追加
1. `loadGameData()`メソッド内の`window.cardsData`配列にエントリを追加
2. `/detail/`ディレクトリに対応する詳細ページを作成
3. アイコン、タイトル、説明、セクション、リンクを含む既存のカード構造に従う
4. カードインタラクションとレベル進行をテスト

### デバッグのヒント
- 現在のゲーム状態を検査するには`console.log(this.gameState)`を使用
- 移動の問題には`characterPosition`値 (0-1) を監視
- 進行追跡の問題には`viewedCards` Setを確認
- ブラウザのDevToolsでLocalStorageの内容を確認
- 追加ログのために`?debug=true` URLパラメーターでテスト
